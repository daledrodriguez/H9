---
- name: Prometheus PATH directory
  file:
    path: ~/prometheus
    state: directory

- name: Creating directory for Prometheus files
  file:
    path:
      - /etc/prometheus
      - /var/lib/prometheus
    mode: 0777
    state: directory

- name: Install Prometheus (CentOS)
  unarchive:
    src: https://github.com/prometheus/prometheus/releases/download/v2.8.1/prometheus-2.8.1.linux-amd64.tar.gz
    dest: ~/prometheus
    remote_src: yes
    mode: 0777
    owner: root
    group: root

- name: Extract and Configure Prometheus
  block:
    - name: Extract Prometheus
      shell: |
        tar -xvzf ~/prometheus/prometheus-2.8.1.linux-amd64.tar.gz -C ~/prometheus/
      args:
        executable: /bin/bash

    - name: Rename Prometheus Directory
      command: mv ~/prometheus/prometheus-2.8.1.linux-amd64 ~/prometheus/prometheuspackage

    - name: Copy Prometheus Binaries
      shell: |
        cp ~/prometheus/prometheuspackage/prometheus /usr/local/bin/
        cp ~/prometheus/prometheuspackage/promtool /usr/local/bin/
      args:
        executable: /bin/bash

    - name: Change Ownership of Prometheus Binaries
      shell: |
        chown prometheus:prometheus /usr/local/bin/prometheus
        chown prometheus:prometheus /usr/local/bin/promtool
      args:
        executable: /bin/bash

    - name: Copy Prometheus Console Files
      shell: |
        cp -r ~/prometheus/prometheuspackage/consoles /etc/prometheus
        cp -r ~/prometheus/prometheuspackage/console_libraries /etc/prometheus
      args:
        executable: /bin/bash

    - name: Change Ownership of Prometheus Console Files
      shell: |
        chown -R prometheus:prometheus /etc/prometheus/consoles
        chown -R prometheus:prometheus /etc/prometheus/console_libraries
      args:
        executable: /bin/bash
  become: yes

- name: Create Prometheus Config File
  copy:
    content: |
      global:
        scrape_interval: 10s

      scrape_configs:
        - job_name: 'prometheus_master'
          scrape_interval: 5s
          static_configs:
            - targets: ['localhost:9090']
    dest: /etc/prometheus/prometheus.yml
    owner: prometheus
    group: prometheus

- name: Change Ownership of Prometheus Config File
  shell: chown prometheus:prometheus /etc/prometheus/prometheus.yml

- name: Configure Prometheus Service File
  copy:
    content: |
      [Unit]
      Description=Prometheus
      Wants=network-online.target
      After=network-online.target

      [Service]
      User=prometheus
      Group=prometheus
      Type=simple
      ExecStart=/usr/local/bin/prometheus \
      --config.file /etc/prometheus/prometheus.yml \
      --storage.tsdb.path /var/lib/prometheus/ \
      --web.console.templates=/etc/prometheus/consoles \
      --web.console.libraries=/etc/prometheus/console_libraries

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/prometheus.service
    owner: root
    group: root

- name: Reload systemd service
  shell: systemctl daemon-reload

- name: Start Prometheus service
  service:
    name: prometheus
    state: started

- name: Check service status
  command: systemctl status prometheus

- name: Add Firewall Rules
  shell: firewall-cmd --zone=public --add-port=9090/tcp --permanent

- name: Reload Firewall Service
  shell: systemctl reload firewalld
